@model IEnumerable<LTT.Models.DataModels.Group>

@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Backend/Views/Shared/_Layout.cshtml";
}
<style>
    .item_group.active > td {
        background: #06c !important;
        color: #fff;
    }
</style>
<!-- Default box -->
<div>
    <div class="box">
        <div class="box-header with-border">
            <h3 class="box-title">@ViewBag.Title</h3>
        </div>
        <div class="box-body">
            <div class="row">
                <div class="col-md-3">
                    <table class="table table-bordered">
                        <tr class="bg-primary">
                            <th>
                                @Html.DisplayNameFor(model => model.Groupname)
                            </th>
                        </tr>

                        @foreach (var item in Model)
                        {
                            <tr data-groupid="@item.GroupId" class="item_group">
                                <td>
                                    @Html.DisplayFor(modelItem => item.Groupname)
                                </td>
                            </tr>
                        }

                    </table>
                    <button class="btn btn-primary">Add new</button>
                </div>
                <div class="col-md-9">
                    <table class="table table-bordered">
                        <tr class="bg-primary">
                            <th>
                                Nghiệp vụ
                            </th>
                            @foreach (var item in ViewBag.Roles)
                            {
                                <th class="text-center">@item.Rolename</th>
                            }
                        </tr>

                        @foreach (var item in ViewBag.Businesses)
                        {
                            <tr>
                                <td>
                                    @item.Businessname
                                </td>
                                @foreach (var r in ViewBag.Roles)
                                {
                                    <td class="text-center">
                                        <input class="item_role" type="checkbox" data-business="@item.BusinessId" name="" value="@r.RoleId" />
                                    </td>
                                }
                            </tr>
                        }

                    </table>
                </div>
            </div>
        </div>
        <!-- /.box-body -->
        <div class="box-footer">
            Footer
        </div>
        <!-- /.box-footer-->
    </div>
</div>
<!-- /.box -->

@section scripts{
    <script>
        $(function () {
            $(".item_role").prop("checked", false);
            $(".item_group").click(function () {
                $(this).addClass("active").siblings().removeClass("active");
                var id = $(this).data("groupid");
                $.ajax({
                    type: "GET",
                    url: "/GroupRoles/GetRoles/" + id,
                    success: function (res) {
                        $(".item_role").prop("checked", false);
                        $.each(res, function () {
                            $(".item_role[value='" + this.RoleId + "'][data-business='" + this.BusinessId + "']").prop("checked", true);
                        })
                    }
                })
            })

            $(".item_role").click(function () {
                var group = $(".item_group.active");
                if (group.length > 0) {
                    // Nếu chọn nhóm rồi thì gán
                    var group_role = {
                        GroupId: group.data("groupid"),
                        RoleId: $(this).val(),
                        BusinessId: $(this).data("business")
                    };
                    $.ajax({
                        type: "POST",
                        url: "/GroupRoles/UpdatePermission",
                        data: group_role,
                        success: function (res) {
                            alert(res.Message);
                        }
                    })
                } else {
                    alert("Vui lòng chọn nhóm quyền!");
                    $(".item_role").prop("checked", false);
                }
            })
        })
    </script>
}